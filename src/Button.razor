@using Microsoft.AspNetCore.Components.Web
@using Soenneker.Extensions.String
@using Soenneker.Quark.Buttons.Enums
@using Soenneker.Quark.Enums.Colors
@using Soenneker.Quark.Enums.Size
@using Soenneker.Quark.Anchors
@using Soenneker.Quark.Spans

@inherits Soenneker.Quark.Components.Element
@inject NavigationManager Navigation

@if (Type == ButtonType.Link)
{
	<Anchor To="To" Attributes="BuildAttributes()"></Anchor>
}
else
{
	<button @attributes="BuildAttributes()" @onclick="HandleClick" >
		@if (Loading)
		{
			<Span Class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></Span>
		}
		@if (LoadingTemplate != null && Loading)
		{
			@LoadingTemplate
		}
		else
		{
			@ChildContent
		}
	</button>
}

@code {

	[Parameter]
	public ButtonType Type { get; set; } = ButtonType.Button;

	[Parameter]
	public bool Disabled { get; set; }

	[Parameter]
	public bool Loading { get; set; }

	[Parameter]
	public RenderFragment? LoadingTemplate { get; set; }

	[Parameter]
	public string? Value { get; set; }

	[Parameter]
	public string? Name { get; set; }

	[Parameter]
	public string? Form { get; set; }

	[Parameter]
	public bool AutoFocus { get; set; }

	[Parameter]
	public string? To { get; set; }

	[Parameter]
	public Size Size { get; set; } = Size.Default;

	[Parameter]
	public Color Color { get; set; } = Color.Primary;

	private string? GetSizeClass()
	{
		if (Size != Size.Default)
			return $"btn-{Size.Value}";

		return null;
	}

	private string? GetColorClass()
	{
		return $"btn-{Color.Value}";
	}

	protected override Dictionary<string, object> BuildAttributes()
	{
		Dictionary<string, object> attributes = base.BuildAttributes();

		// Remove onclick attribute since we handle it directly on the element
		attributes.Remove("onclick");

		// Add default Bootstrap button classes if no class is specified
		if (!Class.HasContent())
		{
			var baseClasses = "btn";
			string? colorClass = GetColorClass();
			string? sizeClass = GetSizeClass();

			if (colorClass != null)
			{
				baseClasses = $"{baseClasses} {colorClass}";
			}
			else
			{
				baseClasses = $"{baseClasses} btn-primary"; // default color
			}

			if (sizeClass != null)
			{
				baseClasses = $"{baseClasses} {sizeClass}";
			}

			attributes["class"] = AppendToClass(attributes.GetValueOrDefault("class")
				?.ToString(), baseClasses);
		}
		else
		{
			// If class is specified, still add color and size classes if not already present
			string currentClass = attributes.GetValueOrDefault("class")
				?.ToString() ?? "";

			string? colorClass = GetColorClass();
			if (colorClass != null && !currentClass.Contains(colorClass))
			{
				currentClass = AppendToClass(currentClass, colorClass);
			}

			string? sizeClass = GetSizeClass();
			if (sizeClass != null && !currentClass.Contains(sizeClass))
			{
				currentClass = AppendToClass(currentClass, sizeClass);
			}

			attributes["class"] = currentClass;
		}

		// Only add type attribute for button elements, not anchor elements
		if (!To.HasContent())
		{
			attributes["type"] = Type.Value;
		}

		// Check if disabled attribute was passed without a value (HTML-style boolean attribute)
		bool isDisabled = Disabled || Loading;
		if (Attributes != null && Attributes.ContainsKey("disabled"))
		{
			// If disabled attribute was passed, treat it as true regardless of the Disabled parameter value
			isDisabled = true;
		}

		if (isDisabled)
			attributes["disabled"] = true;

		if (Value.HasContent())
			attributes["value"] = Value;

		if (Name.HasContent())
			attributes["name"] = Name;

		if (Form.HasContent())
			attributes["form"] = Form;

		if (AutoFocus)
			attributes["autofocus"] = true;

		if (To.HasContent())
		{
			attributes["role"] = "button";
		}

		return attributes;
	}

	protected override async Task HandleClick(MouseEventArgs args)
	{
		// Check if disabled attribute was passed without a value (HTML-style boolean attribute)
		bool isDisabled = Disabled || Loading;
		if (Attributes != null && Attributes.ContainsKey("disabled"))
		{
			// If disabled attribute was passed, treat it as true regardless of the Disabled parameter value
			isDisabled = true;
		}

		if (!isDisabled)
		{
			// Handle programmatic navigation if To is set but we're not using NavLink
			if (To.HasContent() && !To.StartsWith("#"))
			{
				Navigation.NavigateTo(To);
			}

			await base.HandleClick(args);
		}
	}

}